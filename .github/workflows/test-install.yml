# Manual workflow to test the one-line install (and on macOS, Homebrew tap install)
# across supported platforms. Uses the install script and package managers as documented
# in README.md.
name: Test Install

on:
  workflow_dispatch: {}

jobs:
  install-macos-oneline-homebrew:
    name: macOS ${{ matrix.arch }} (one-line + Homebrew)
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: macos-14
            arch: arm64
          - runner: macos-15-intel
            arch: x86_64
    steps:
      - name: One-line install
        run: |
          curl -fsSL https://raw.githubusercontent.com/derekwisong/datui/main/scripts/install/install.sh | sh

      - name: Verify one-line install
        run: datui --version

      - name: Remove one-line install for Homebrew test
        run: |
          sudo rm -f /usr/local/bin/datui
          sudo rm -f /usr/local/share/man/man1/datui.1*

      - name: Homebrew tap install
        run: |
          brew tap derekwisong/datui
          brew install datui

      - name: Verify Homebrew install
        run: datui --version

  install-ubuntu-oneline:
    name: Debian-based Linux
    runs-on: ubuntu-latest
    steps:
      - name: One-line install
        run: |
          curl -fsSL https://raw.githubusercontent.com/derekwisong/datui/main/scripts/install/install.sh | sh

      - name: Verify install
        run: datui --version

  install-fedora-oneline:
    name: RPM-based Linux
    runs-on: ubuntu-latest
    container:
      image: fedora:40
      options: --privileged --user 0
    steps:
      - name: One-line install
        run: |
          curl -fsSL https://raw.githubusercontent.com/derekwisong/datui/main/scripts/install/install.sh | sh

      - name: Verify install
        run: datui --version

  install-arch-oneline:
    name: Arch Linux
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
      options: --privileged --user 0
    steps:
      - name: Install runtime dependency (fontconfig)
        run: pacman -Sy --noconfirm fontconfig
      - name: One-line install
        run: |
          curl -fsSL https://raw.githubusercontent.com/derekwisong/datui/main/scripts/install/install.sh | sh

      - name: Verify install
        run: datui --version

  install-arch-aur:
    name: Arch Linux (AUR datui-bin)
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
      options: --privileged --user 0
    steps:
      - name: Bootstrap Arch for AUR
        run: |
          pacman -Syu --noconfirm base-devel git sudo
          useradd -m -s /bin/bash builder
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers

      - name: Install paru (AUR helper)
        run: |
          sudo -u builder bash -c '
            cd /tmp &&
            git clone https://aur.archlinux.org/paru.git &&
            cd paru &&
            makepkg -si --noconfirm
          '

      - name: Install datui-bin from AUR
        run: |
          sudo -u builder paru -S datui-bin --noconfirm --removemake --cleanafter

      - name: Verify AUR install
        run: datui --version

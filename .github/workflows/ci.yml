name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read

jobs:
  check:
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/heads/')
    outputs:
      is_dev_version: ${{ steps.version.outputs.is_dev_version }}
    env:
      CARGO_TARGET_DIR: ${{ github.workspace }}/target
    steps:
      - uses: actions/checkout@v4

      - name: Set dev version output
        id: version
        run: |
          VERSION=$(sed -n '/^\[package\]/,/^\[/p' Cargo.toml | grep -E '^\s*version\s*=' | head -1 | sed 's/.*"\([^"]*\)".*/\1/')
          if [[ "$VERSION" == *-dev ]]; then
            echo "is_dev_version=true" >> "$GITHUB_OUTPUT"
          else
            echo "is_dev_version=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y pkg-config libfontconfig1-dev

      - name: Cache cargo dependencies
        uses: swatinem/rust-cache@v2
        with:
          shared-key: ci

      - name: Make scripts executable
        run: chmod +x scripts/check_format.sh scripts/check_clippy.sh

      - name: Check formatting
        run: ./scripts/check_format.sh

      - name: Run clippy
        run: ./scripts/check_clippy.sh

  linux:
    runs-on: ubuntu-latest
    needs: [check]
    if: startsWith(github.ref, 'refs/heads/')
    env:
      CARGO_TARGET_DIR: ${{ github.workspace }}/target
    steps:
      - uses: actions/checkout@v4

      - name: Free disk space (Ubuntu)
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y pkg-config libfontconfig1-dev python3-dev

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
          cache: 'pip'
          cache-dependency-path: |
            scripts/requirements.txt
            scripts/requirements-wheel.txt
            scripts/requirements-wheel-windows.txt
            python/pyproject.toml

      - name: Cache cargo dependencies
        uses: swatinem/rust-cache@v2
        with:
          shared-key: ci

      - name: Create virtual environment and install requirements
        run: |
          python -m venv .venv
          .venv/bin/python -m pip install --upgrade pip
          .venv/bin/pip install -r scripts/requirements.txt
          .venv/bin/pip install -r scripts/requirements-wheel.txt

      - name: Generate sample data
        run: .venv/bin/python scripts/generate_sample_data.py

      - name: Build
        run: cargo build --workspace --tests --locked

      - name: Run tests
        run: cargo test --workspace --locked

      - name: Verify binary exists
        run: test -f target/debug/datui || (echo "Binary not found" && exit 1)

      - name: Verify manpage was generated
        run: |
          if ! find target/debug/build -name "datui.1" -type f | head -1 >/dev/null; then
            echo "Manpage not found" && exit 1
          fi

      - name: Bundle CLI for wheel
        run: |
          mkdir -p python/datui_bin
          cp target/debug/datui python/datui_bin/
          chmod +x python/datui_bin/datui
          cp LICENSE python/LICENSE

      - name: Build and install Python package
        env:
          CARGO_TARGET_DIR: ${{ github.workspace }}/target
        run: . .venv/bin/activate && cd python && maturin develop

      - name: Run Python tests
        run: . .venv/bin/activate && pytest python/tests/ -v

  windows:
    runs-on: windows-latest
    needs: [check]
    if: startsWith(github.ref, 'refs/heads/') && needs.check.outputs.is_dev_version != 'true'
    env:
      CARGO_TARGET_DIR: ${{ github.workspace }}/target
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
          cache: 'pip'
          cache-dependency-path: |
            scripts/requirements.txt
            scripts/requirements-wheel.txt
            scripts/requirements-wheel-windows.txt
            python/pyproject.toml

      - name: Cache cargo dependencies
        uses: swatinem/rust-cache@v2
        with:
          shared-key: ci

      - name: Create virtual environment and install requirements
        run: |
          python -m venv .venv
          .venv\Scripts\python.exe -m pip install --upgrade pip
          .venv\Scripts\pip.exe install -r scripts/requirements.txt
          .venv\Scripts\pip.exe install -r scripts/requirements-wheel-windows.txt

      - name: Generate sample data
        run: .venv\Scripts\python.exe scripts/generate_sample_data.py

      - name: Build
        run: cargo build --workspace --tests --locked

      - name: Run tests
        run: cargo test --workspace --locked

      - name: Verify binary exists
        run: |
          if (!(Test-Path target\debug\datui.exe)) { Write-Error "Binary not found"; exit 1 }

      - name: Bundle CLI for wheel
        run: |
          New-Item -ItemType Directory -Force -Path python/datui_bin
          Copy-Item target/debug/datui.exe python/datui_bin/
          Copy-Item LICENSE python/LICENSE

      - name: Build and install Python package
        env:
          CARGO_TARGET_DIR: ${{ github.workspace }}/target
        run: |
          .\.venv\Scripts\Activate.ps1
          cd python
          maturin develop

      - name: Run Python tests
        run: |
          .\.venv\Scripts\Activate.ps1
          pytest python/tests/ -v

  macos:
    runs-on: macos-latest
    needs: [check]
    if: startsWith(github.ref, 'refs/heads/') && needs.check.outputs.is_dev_version != 'true'
    env:
      CARGO_TARGET_DIR: ${{ github.workspace }}/target
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
          cache: 'pip'
          cache-dependency-path: |
            scripts/requirements.txt
            scripts/requirements-wheel.txt
            scripts/requirements-wheel-windows.txt
            python/pyproject.toml

      - name: Cache cargo dependencies
        uses: swatinem/rust-cache@v2
        with:
          shared-key: ci

      - name: Create virtual environment and install requirements
        run: |
          python -m venv .venv
          .venv/bin/python -m pip install --upgrade pip
          .venv/bin/pip install -r scripts/requirements.txt
          .venv/bin/pip install -r scripts/requirements-wheel.txt

      - name: Generate sample data
        run: .venv/bin/python scripts/generate_sample_data.py

      - name: Build
        run: cargo build --workspace --tests --locked

      - name: Run tests
        run: cargo test --workspace --locked

      - name: Verify binary exists
        run: test -f target/debug/datui || (echo "Binary not found" && exit 1)

      - name: Verify manpage was generated
        run: |
          if ! find target/debug/build -name "datui.1" -type f | head -1 >/dev/null; then
            echo "Manpage not found" && exit 1
          fi

      - name: Bundle CLI for wheel
        run: |
          mkdir -p python/datui_bin
          cp target/debug/datui python/datui_bin/
          chmod +x python/datui_bin/datui
          cp LICENSE python/LICENSE

      - name: Build and install Python package
        env:
          CARGO_TARGET_DIR: ${{ github.workspace }}/target
        run: . .venv/bin/activate && cd python && maturin develop

      - name: Run Python tests
        run: . .venv/bin/activate && pytest python/tests/ -v

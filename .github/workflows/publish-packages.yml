# Reusable workflow: publish to crates.io, AUR, PyPI, Homebrew, WinGet, and APT (datui-apt) after a release is created.
# Invoked by the Release workflow at the end of its publish step, or run manually (Actions → Publish packages → Run workflow).
# Manual run with no tag uses the latest GitHub release.
# Prerequisites: repository secrets for CARGO_REGISTRY_TOKEN (crates.io), HOMEBREW_TAP_TOKEN, PYPI_API_TOKEN, AUR_*, WINGET_TOKEN, and for APT: GPG_PRIVATE_KEY, GPG_EMAIL, DATUI_APT_TOKEN.
# WinGet: at least one version of derekwisong.datui must exist in winget-pkgs; fork microsoft/winget-pkgs; WINGET_TOKEN = classic PAT with public_repo scope.
name: Publish packages

on:
  workflow_call:
    inputs:
      tag_name:
        description: 'Release tag name (e.g. v1.0.0)'
        required: true
        type: string
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Release tag (blank = latest release)'
        required: false
        type: string
        default: ''

permissions:
  contents: read

jobs:
  resolve-release:
    runs-on: ubuntu-latest
    outputs:
      tag_name: ${{ steps.export_tag.outputs.tag_name }}
    steps:
      - name: Resolve release tag
        id: resolve_tag
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -n "${{ inputs.tag_name }}" ]; then
            TAG="${{ inputs.tag_name }}"
          else
            TAG=$(gh release list --repo ${{ github.repository }} --limit 1 --json tagName -q '.[0].tagName')
          fi
          echo "tag_name=$TAG" >> "$GITHUB_OUTPUT"
          echo "Resolved release tag: $TAG"

      - name: Export tag for job output
        id: export_tag
        run: echo "tag_name=${{ steps.resolve_tag.outputs.tag_name }}" >> "$GITHUB_OUTPUT"

  publish-crates-io:
    needs: resolve-release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout at release tag
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.resolve-release.outputs.tag_name }}
          fetch-depth: 0

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y pkg-config libfontconfig1-dev

      - name: Publish to crates.io
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          for crate in datui-cli datui-lib datui; do
            set +e
            output=$(cargo publish -p "$crate" --locked 2>&1)
            ret=$?
            set -e
            if [ "$ret" -eq 0 ]; then
              echo "Published $crate"
            elif echo "$output" | grep -qE "already uploaded|is already on the registry|already published|already exists on crates.io index"; then
              echo "::notice:: $crate at this version is already on crates.io, skipping"
            else
              echo "$output"
              exit 1
            fi
          done

  publish-homebrew:
    needs: resolve-release
    runs-on: ubuntu-latest
    steps:
      - name: Download macOS tarballs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release download "${{ needs.resolve-release.outputs.tag_name }}" --repo ${{ github.repository }} --pattern '*-apple-darwin.tar.gz'

      - name: Get Homebrew formula template
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p scripts
          curl -sL -H "Authorization: token $GH_TOKEN" -H "Accept: application/vnd.github.raw" \
            "https://api.github.com/repos/${{ github.repository }}/contents/scripts/homebrew-formula.rb.template?ref=${{ needs.resolve-release.outputs.tag_name }}" \
            -o scripts/homebrew-formula.rb.template

      - name: Compute macOS tarball checksums for Homebrew
        id: brew_checksums
        run: |
          VERSION="${{ needs.resolve-release.outputs.tag_name }}"
          echo "version=${VERSION#v}" >> "$GITHUB_OUTPUT"
          echo "tag=$VERSION" >> "$GITHUB_OUTPUT"
          echo "sha_arm64=$(sha256sum *-aarch64-apple-darwin.tar.gz | awk '{print $1}')" >> "$GITHUB_OUTPUT"
          echo "sha_x64=$(sha256sum *-x86_64-apple-darwin.tar.gz | awk '{print $1}')" >> "$GITHUB_OUTPUT"

      - name: Update Homebrew tap
        if: env.HOMEBREW_TAP_TOKEN != ''
        env:
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          REPO="${{ github.repository }}"
          TAG="${{ steps.brew_checksums.outputs.tag }}"
          VERSION="${{ steps.brew_checksums.outputs.version }}"
          SHA_ARM64="${{ steps.brew_checksums.outputs.sha_arm64 }}"
          SHA_X64="${{ steps.brew_checksums.outputs.sha_x64 }}"
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git clone --depth 1 "https://x-access-token:${HOMEBREW_TAP_TOKEN}@github.com/derekwisong/homebrew-datui.git" tap
          cd tap
          mkdir -p Formula
          sed -e "s/VERSION_PLACEHOLDER/$VERSION/" \
              -e "s|URL_ARM64_PLACEHOLDER|https://github.com/$REPO/releases/download/$TAG/datui-$TAG-aarch64-apple-darwin.tar.gz|" \
              -e "s/SHA_ARM64_PLACEHOLDER/$SHA_ARM64/" \
              -e "s|URL_X64_PLACEHOLDER|https://github.com/$REPO/releases/download/$TAG/datui-$TAG-x86_64-apple-darwin.tar.gz|" \
              -e "s/SHA_X64_PLACEHOLDER/$SHA_X64/" \
              "$GITHUB_WORKSPACE/scripts/homebrew-formula.rb.template" > Formula/datui.rb
          git add Formula/datui.rb
          git diff --staged --quiet || (git commit -m "datui $VERSION" && git push)

  publish-pypi:
    needs: resolve-release
    runs-on: ubuntu-latest
    steps:
      - name: Download wheel assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release download "${{ needs.resolve-release.outputs.tag_name }}" --repo ${{ github.repository }} --pattern '*.whl'

      - name: Publish to PyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          # Twine 6.2+ and packaging 24.2+ support PEP 639 License-File metadata.
          pip install 'twine>=6.2' 'packaging>=24.2'
          twine upload --skip-existing *.whl

  publish-aur:
    needs: resolve-release
    runs-on: ubuntu-latest
    steps:
      - name: Download PKGBUILD from release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release download "${{ needs.resolve-release.outputs.tag_name }}" --repo ${{ github.repository }} --pattern 'PKGBUILD'

      - name: Publish to AUR (datui-bin package)
        uses: KSXGitHub/github-actions-deploy-aur@v2.7.1
        with:
          pkgname: datui-bin
          pkgbuild: PKGBUILD
          commit_username: ${{ secrets.AUR_USERNAME }}
          commit_email: ${{ secrets.AUR_EMAIL }}
          ssh_private_key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
          commit_message: Update to ${{ needs.resolve-release.outputs.tag_name }}
          ssh_keyscan_types: rsa,ecdsa,ed25519

  publish-winget:
    needs: resolve-release
    runs-on: windows-latest
    # winget-releaser fetches release assets via GitHub API; no local download needed
    steps:
      - name: Open winget-pkgs PR
        uses: vedantmgoyal9/winget-releaser@main
        with:
          identifier: derekwisong.datui
          installers-regex: '-windows-x86_64\.zip$'
          release-tag: ${{ needs.resolve-release.outputs.tag_name }}
          token: ${{ secrets.WINGET_TOKEN }}
          max-versions-to-keep: 20

  publish-apt:
    needs: resolve-release
    runs-on: ubuntu-latest
    steps:
      - name: Install APT tools
        run: |
          sudo apt-get update
          sudo apt-get install -y dpkg-dev apt-utils gpg

      - name: Import GPG key
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        run: |
          echo "$GPG_PRIVATE_KEY" | gpg --batch --import

      - name: Download .deb from release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p dist
          gh release download "${{ needs.resolve-release.outputs.tag_name }}" --repo ${{ github.repository }} --pattern "*.deb" --dir dist

      - name: Generate repository metadata
        working-directory: dist
        env:
          GPG_EMAIL: ${{ secrets.GPG_EMAIL }}
        run: |
          gpg --armor --export "$GPG_EMAIL" > public.key
          dpkg-scanpackages --multiversion . > Packages
          gzip -k -f Packages
          apt-ftparchive release . > Release
          gpg --batch --yes -u "$GPG_EMAIL" -abs -o Release.gpg Release
          gpg --batch --yes -u "$GPG_EMAIL" --clearsign -o InRelease Release

      - name: Deploy to datui-apt
        uses: peaceiris/actions-gh-pages@v3
        with:
          personal_token: ${{ secrets.DATUI_APT_TOKEN }}
          external_repository: derekwisong/datui-apt
          publish_dir: ./dist
          publish_branch: gh-pages
          force_orphan: true
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'

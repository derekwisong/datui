# Reusable workflow: publish to crates.io, AUR, PyPI, Homebrew, and WinGet after a release is created.
# Invoked by the Release workflow at the end of its publish step, or run manually (Actions → Publish packages → Run workflow).
# Manual run with no tag uses the latest GitHub release.
# Prerequisites: repository secrets for CARGO_REGISTRY_TOKEN (crates.io), HOMEBREW_TAP_TOKEN, PYPI_API_TOKEN, AUR_*, WINGET_TOKEN.
# WinGet: at least one version of derekwisong.datui must exist in winget-pkgs; fork microsoft/winget-pkgs; WINGET_TOKEN = classic PAT with public_repo scope.
name: Publish packages

on:
  workflow_call:
    inputs:
      tag_name:
        description: 'Release tag name (e.g. v1.0.0)'
        required: true
        type: string
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Release tag (blank = latest release)'
        required: false
        type: string
        default: ''

permissions:
  contents: read

jobs:
  publish-crates-io:
    runs-on: ubuntu-latest
    steps:
      - name: Resolve release tag
        id: resolve-tag
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -n "${{ inputs.tag_name }}" ]; then
            echo "tag_name=${{ inputs.tag_name }}" >> "$GITHUB_OUTPUT"
          else
            TAG=$(gh release list --repo ${{ github.repository }} --limit 1 --json tagName -q '.[0].tagName')
            echo "tag_name=$TAG" >> "$GITHUB_OUTPUT"
          fi
          echo "Publishing to crates.io: ${{ steps.resolve-tag.outputs.tag_name }}"

      - name: Checkout at release tag
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.resolve-tag.outputs.tag_name }}
          fetch-depth: 0

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y pkg-config libfontconfig1-dev

      - name: Publish to crates.io
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          cargo publish -p datui-cli --locked
          cargo publish -p datui-lib --locked
          cargo publish -p datui --locked

  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Resolve release tag
        id: resolve-tag
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -n "${{ inputs.tag_name }}" ]; then
            echo "tag_name=${{ inputs.tag_name }}" >> "$GITHUB_OUTPUT"
          else
            TAG=$(gh release list --repo ${{ github.repository }} --limit 1 --json tagName -q '.[0].tagName')
            echo "tag_name=$TAG" >> "$GITHUB_OUTPUT"
          fi
          echo "Publishing release ${{ steps.resolve-tag.outputs.tag_name }}"

      - name: Download release assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release download "${{ steps.resolve-tag.outputs.tag_name }}" --repo ${{ github.repository }}

      - name: Get Homebrew formula template
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p scripts
          curl -sL -H "Authorization: token $GH_TOKEN" -H "Accept: application/vnd.github.raw" \
            "https://api.github.com/repos/${{ github.repository }}/contents/scripts/homebrew-formula.rb.template?ref=${{ steps.resolve-tag.outputs.tag_name }}" \
            -o scripts/homebrew-formula.rb.template

      - name: Compute macOS tarball checksums for Homebrew
        id: brew-checksums
        run: |
          VERSION="${{ steps.resolve-tag.outputs.tag_name }}"
          echo "version=${VERSION#v}" >> "$GITHUB_OUTPUT"
          echo "tag=$VERSION" >> "$GITHUB_OUTPUT"
          echo "sha_arm64=$(sha256sum *-aarch64-apple-darwin.tar.gz | awk '{print $1}')" >> "$GITHUB_OUTPUT"
          echo "sha_x64=$(sha256sum *-x86_64-apple-darwin.tar.gz | awk '{print $1}')" >> "$GITHUB_OUTPUT"

      - name: Update Homebrew tap
        if: env.HOMEBREW_TAP_TOKEN != ''
        env:
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          REPO="${{ github.repository }}"
          TAG="${{ steps.brew-checksums.outputs.tag }}"
          VERSION="${{ steps.brew-checksums.outputs.version }}"
          SHA_ARM64="${{ steps.brew-checksums.outputs.sha_arm64 }}"
          SHA_X64="${{ steps.brew-checksums.outputs.sha_x64 }}"
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git clone --depth 1 "https://x-access-token:${HOMEBREW_TAP_TOKEN}@github.com/derekwisong/homebrew-datui.git" tap
          cd tap
          mkdir -p Formula
          sed -e "s/VERSION_PLACEHOLDER/$VERSION/" \
              -e "s|URL_ARM64_PLACEHOLDER|https://github.com/$REPO/releases/download/$TAG/datui-$TAG-aarch64-apple-darwin.tar.gz|" \
              -e "s/SHA_ARM64_PLACEHOLDER/$SHA_ARM64/" \
              -e "s|URL_X64_PLACEHOLDER|https://github.com/$REPO/releases/download/$TAG/datui-$TAG-x86_64-apple-darwin.tar.gz|" \
              -e "s/SHA_X64_PLACEHOLDER/$SHA_X64/" \
              "$GITHUB_WORKSPACE/scripts/homebrew-formula.rb.template" > Formula/datui.rb
          git add Formula/datui.rb
          git diff --staged --quiet || (git commit -m "datui $VERSION" && git push)

      - name: Publish to PyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          # Twine 6.2+ and packaging 24.2+ support PEP 639 License-File metadata.
          pip install 'twine>=6.2' 'packaging>=24.2'
          twine upload --skip-existing *.whl

      - name: Publish to AUR (datui-bin package)
        uses: KSXGitHub/github-actions-deploy-aur@v2.7.1
        with:
          pkgname: datui-bin
          pkgbuild: PKGBUILD
          commit_username: ${{ secrets.AUR_USERNAME }}
          commit_email: ${{ secrets.AUR_EMAIL }}
          ssh_private_key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
          commit_message: Update to ${{ steps.resolve-tag.outputs.tag_name }}
          ssh_keyscan_types: rsa,ecdsa,ed25519

  # winget:
  #   runs-on: windows-latest
  #   steps:
  #     - name: Open winget-pkgs PR
  #       uses: vedantmgoyal9/winget-releaser@main
  #       with:
  #         identifier: derekwisong.datui
  #         installers-regex: '-windows-x86_64\.zip$'
  #         token: ${{ secrets.WINGET_TOKEN }}

          # Optional: keep only the latest N versions in winget (0 = keep all)
          # max-versions-to-keep: 5
          # If your winget-pkgs fork is under a different user, set fork-user:
          # fork-user: your-fork-username

# Quick test for the Homebrew tap update logic. Run manually against an existing
# release; does not run the full release pipeline. Use after at least one release
# exists (with macOS tarballs).
name: Test Homebrew tap update

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag to use (e.g. v0.1.0)'
        required: true
        default: 'v0.1.0'

jobs:
  update-tap:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download macOS tarballs from release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ github.event.inputs.tag }}"
          mkdir -p macos-aarch64 macos-x86_64
          gh release download "$TAG" \
            --repo ${{ github.repository }} \
            --pattern '*-aarch64-apple-darwin.tar.gz' \
            --dir macos-aarch64
          gh release download "$TAG" \
            --repo ${{ github.repository }} \
            --pattern '*-x86_64-apple-darwin.tar.gz' \
            --dir macos-x86_64

      - name: Compute macOS tarball checksums for Homebrew
        id: brew-checksums
        run: |
          TAG="${{ github.event.inputs.tag }}"
          VERSION="${TAG#v}"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "sha_arm64=$(sha256sum macos-aarch64/datui-*.tar.gz | awk '{print $1}')" >> "$GITHUB_OUTPUT"
          echo "sha_x64=$(sha256sum macos-x86_64/datui-*.tar.gz | awk '{print $1}')" >> "$GITHUB_OUTPUT"

      - name: Update Homebrew tap
        if: env.HOMEBREW_TAP_TOKEN != ''
        env:
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          REPO="${{ github.repository }}"
          TAG="${{ steps.brew-checksums.outputs.tag }}"
          VERSION="${{ steps.brew-checksums.outputs.version }}"
          SHA_ARM64="${{ steps.brew-checksums.outputs.sha_arm64 }}"
          SHA_X64="${{ steps.brew-checksums.outputs.sha_x64 }}"
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git clone --depth 1 "https://x-access-token:${HOMEBREW_TAP_TOKEN}@github.com/derekwisong/homebrew-datui.git" tap
          cd tap
          mkdir -p Formula
          sed -e "s/VERSION_PLACEHOLDER/$VERSION/" \
              -e "s|URL_ARM64_PLACEHOLDER|https://github.com/$REPO/releases/download/$TAG/datui-$TAG-aarch64-apple-darwin.tar.gz|" \
              -e "s/SHA_ARM64_PLACEHOLDER/$SHA_ARM64/" \
              -e "s|URL_X64_PLACEHOLDER|https://github.com/$REPO/releases/download/$TAG/datui-$TAG-x86_64-apple-darwin.tar.gz|" \
              -e "s/SHA_X64_PLACEHOLDER/$SHA_X64/" \
              "$GITHUB_WORKSPACE/scripts/homebrew-formula.rb.template" > Formula/datui.rb
          git add Formula/datui.rb
          git diff --staged --quiet || (git commit -m "datui $VERSION" && git push)
